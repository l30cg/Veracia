{% extends "base/base.html" %}
{% load static %}

{% block css %}
{% endblock %}

{% block title %}
   Inicio
{% endblock %}

{% block content %}
   <div class="container-carrousel">
      <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
         <ol class="carousel-indicators">
         <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
         <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
         <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
         </ol>
         <div class="carousel-inner">
         <div class="carousel-item active">
            <img src="{% static 'img/banner2.png' %}" style="object-fit: fill;">
         </div>
         <!--<div class="carousel-item">
            <img src="{% static 'img/carrousel2.jpg' %}">
         </div>
         <div class="carousel-item">
            <img src="{% static 'img/carrousel3.jpg' %}">
         </div>-->
         </div>
         <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
         <span class="carousel-control-prev-icon" aria-hidden="true"></span>
         <span class="sr-only">Previous</span>
         </a>
         <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
         <span class="carousel-control-next-icon" aria-hidden="true"></span>
         <span class="sr-only">Next</span>
         </a>
      </div>
   </div>
   <div class="container-content">
      {% if noticias %}
      <div class="dropdown" id="indice_btn">
         <button
           class="btn btn-primary dropdown-toggle"
           type="button"
           id="dropdownMenuButton"
           data-mdb-toggle="dropdown"
           aria-expanded="false"
         >
           Índice
         </button>
         <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            {% for n in noticias %}
            <li><a class="dropdown-item" data-index="{{n.index}}">{{ n.name }}</a></li>
            {% endfor %}
         </ul>
      </div>
      {% endif %}




      <form method="POST" class="container-index">
         <div class="content-left" style="width: 80%;">
            {% csrf_token %}
            <div class="content-left-title">
               <p id="inicio">Noticia</p>
            </div>
            <div id="container" class="content-left-content" style="margin-top: 20px; margin-bottom: 20px;">
               <div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                  <img id="arrow" src="../../static/img/arrow_down.png" style="object-fit: contain; width: 20.5px; height: 20.5px; margin-right: 8px;"/>

                  <textarea id="input_noticia" name="text" cols="30" rows="10" placeholder="Ingresar noticia">{{ text }}</textarea>
                  
                  <button id="analyze" class="content-left-content-analyze" name="analyze" style="border-radius: 100px; width: 50px; height: 50px; right: 57px; top: 0px; margin: 0px;">
                     <img src="../../static/img/lupa_azul.png" style="object-fit: contain; width: 20px; height: 20px;"/>
                     <span id="loader" class="loader d-none"></span>
                  </button>

                  {% if noticias %}
                     <a id="pdf" name="clean" style="margin-left: -30px;"><img src="../../static/img/descargar_pdf.png" style="object-fit: contain; width: 60px; height: 60px;"/></a>
                  {% endif %}
               </div>
            </div>

            {% if noticias %}
            <div class="content-left-title" id="barra_art_capturados">
               <p>Artículos capturados</p>
            </div>
            <div id="lista_noticias"></div>


            <div class="content-left-title">
               <p>Veredicto</p>
            </div>
            <div class="content-left-content">
               <div class="content-middle">
                  <div class="content-middle-data">
                     <span class="content-middle-data-item">
                        <table class="table">
                           <tbody>
                           {%if noticias %}
                              {%for row in noticias%}
                                 <tr>
                                    <td>
                                       {%if row.veredicto == '-' %}• No se encontró información que Confirme o Contradiga la noticia {{forloop.counter}}.{%endif%}

                                       {%if row.veredicto == 'Contradicción' %}• La noticia {{forloop.counter}} contiene información Falsa. {%endif%}

                                       {%if row.veredicto == 'Confirmación' %}• La noticia {{forloop.counter}} menciona información Verdadera.{%endif%}
                                    </td>
                                 </tr>
                              {%endfor%}
                           {%endif%}
                           </tbody>
                        </table>
                     </span>
                  </div>
               </div>
            </div>


            <div class="content-left-title">
               <p>Hechos detectados</p>
            </div>
            <div class="content-left-content">
               <div class="content-middle">
                  <div class="content-middle-data">
                     <span class="content-middle-data-item">
                        <table class="table">
                           <thead style="background-color: rgb(30,67,126); color: white;">
                             <tr>
                              <th scope="col">Hecho en la noticia</th>
                              <th scope="col">Nota</th>
                              <th scope="col">Hechos en las notas relacionadas</th>
                              <th scope="col">Resultado</th>
                             </tr>
                           </thead>
                           <tbody>
                             {%if noticias %}
                               {%for row in noticias%}
                                 <tr>
                                    <td>{%if noticia_buscada %} {{noticia_buscada}} {%endif%}</td>
                                    <td scope="row">{{forloop.counter}}</td>
                                    <td>{{row.title}}</td>
                                    <td>{{row.veredicto}}</td>
                                 </tr>
                              {%endfor%}
                             {%endif%}
                           </tbody>
                         </table>
                     </span>
                  </div>
               </div>
            </div>
            {% endif %}
         </div>
      </form>
   </div>
{% endblock %}

{% block js %}
<script type="text/javascript">
   const analyze = document.getElementById("analyze");
   const loader  = document.getElementById("loader");

   analyze.addEventListener("click", function(e)
   {
      loader.classList.remove("d-none");
   });

   $('#arrow').on('click', function()
   {
      $(this).toggleClass('up');
      const input = $('#input_noticia');
      input.toggleClass('expanded');
      if (input.hasClass('expanded'))
      {
         input.attr('placeholder', 'Ingresar artículo');
         $('#container').css('margin-top', '10px');
      }
      else
      {
         input.attr('placeholder', 'Buscar noticia');
         $('#container').css('margin-top', '20px');
      }
   });
</script>

{% if noticias %}
{{ noticias|json_script:"noticias" }}
{{ noticia_buscada|json_script:"noticia_buscada" }}

<script type='text/javascript'>
   const noticias = JSON.parse(document.getElementById('noticias').textContent);
   var query = JSON.parse(document.getElementById('noticia_buscada').textContent);
   console.log('NOTICIAS:', noticias);
   console.log('QUERY:', query);

   for (n of noticias)
   {
      $('#lista_noticias').append(
      `
      <div class="content-left-content" id="noticia${n.index}">
         <div class="content-middle">
            <div class="content-middle-data bg-blue" style="display: flex; flex-direction: row; justify-content: space-between;" id="header_noticia">
               <div>
                  <p id="noticia_title" style="font-weight: bolder; text-align: center; margin-bottom: 20px; color: rgb(30,67,126);">${n.title}</p>
                  <p>
                     URL:
                     <a target="_blank" href="${n.url}"><span id="noticia_url" class="content-middle-data-item" style="color: rgb(92,92,92);">${n.url}</span></a>
                  </p>
               </div>
            </div>
         </div>
         <div id="noticia_body" class="body">${n.body}</div>
      </div>
      `);
   }

   setTimeout(() => {
      $('#patron0')[0].scrollIntoView({behavior: 'smooth'});
   }, 100);
   
   $('body').on('click', '#pdf', function(e)
   {
      let arr = [];
      for (n of noticias)
      {
         let
         obj = {
            title: n.title,
            url: n.url,
            relevant: null
         },
         relevant = [],
         y = $('<div></div>').html(n.body).find('span.relevante');
         for (x of y)
            relevant.push(x.innerHTML);
         obj.relevant = relevant;
         arr.push(obj);
      }

      let
      win   = window.open('', '', 'height=400,width=800'),
      html  = `
         <!DOCTYPE html><html lang="en"><head><title>${query}</title>
         <link rel="preconnect" href="https://fonts.googleapis.com">
         <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
         <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
	      <link href="https://fonts.googleapis.com/css2?family=Saira:ital,wght@0,400;1,500&display=swap" rel="stylesheet">	
         <style>
            table,th,td{border:1px solid black; border-radius: 4px;}
            body,a{font-family: 'Saira', sans-serif;}
            td{padding-left: 15px; background-color: rgba(255,254,214,0);}
            th{font-family: 'Ubuntu', sans-serif; background-color: rgb(242,248,255); color: rgb(40,40,60);}
         </style>
         </head>
         <body><h2>${query}</h2><table>
      `;
      
      for (i of arr)
      {
         html += `<tr><th>${i.title}<br/><a href="${i.url}">${i.url}</a></th></tr><tr><td>`;
         for (let j = 0; j < i.relevant.length; ++j)
         {
            html += `${i.relevant[j]}<br/>`;
            if (j < i.relevant.length - 1)
               html += `<br/>`;
         }
         html += `</td></tr>`;
      }
      html += `</table></body></html>`;
      win.document.write(html);

      win.document.close();
      win.print();
   });

   $('body').on('click', '#noticia_url', function(e)
   {
      console.log('Click link');
      e.preventDefault();
      window.open($('#noticia_url').prop('href'), "_blank");
   });

   $('body').on('click', '.dropdown-item', function()
   {
      $('#noticia'+$(this).attr('data-index'))[0].scrollIntoView({behavior: 'smooth'});
   });
</script>

{% endif %}
{% endblock %}